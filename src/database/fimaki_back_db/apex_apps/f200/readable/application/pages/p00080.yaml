---
# ====== Page: Registrar Cancelacion =========================
id: 80
identification: 
  name: Registrar Cancelacion
  alias: REGISTRAR-CANCELACION
  title: Registrar Cancelación

appearance: 
  page-mode: Modal Dialog
  dialog-template: Theme Default
  template-options: 
  - '#DEFAULT#'

dialog: 
  width: 812
  chained: false
  resizable: false

navigation-menu: 
  override-user-interface-level: false

navigation: 
  cursor-focus: First item on page
  warn-on-unsaved-changes: false

security: 
  authentication: Page Requires Authentication
  deep-linking: Application Default
  page-access-protection: Arguments Must Have Checksum
  form-auto-complete: Off
  browser-cache: Application Default

session-management: 
  rejoin-sessions: Application Default

advanced: 
  enable-duplicate-page-submissions: Yes - Enable page to be re-posted
  reload-on-submit: Only for Success

server-cache: 
  caching: Disabled

regions: 
- # ====== Region: Registro de Cancelacion =====================
  id: 33141055977256325
  identification: 
    name: Registro de Cancelacion
    type: Static Content

  layout: 
    sequence: 20
    parent-region: No Parent
    slot: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Blank with Attributes
    template-options: 
    - '#DEFAULT#'
    - t-Form--slimPadding
    render-components: Above Content

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: false
    exclude-title-from-translation: false

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    settings: 
      output-as: HTML
      expand-shortcuts: false

- # ====== Region: Botonera ====================================
  id: 33141102698256326
  identification: 
    name: Botonera
    type: Static Content

  layout: 
    sequence: 10
    parent-region: No Parent
    slot: REGION_POSITION_03
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Buttons Container
    template-options: 
    - '#DEFAULT#'
    - t-Form--slimPadding
    render-components: Above Content

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: false
    exclude-title-from-translation: false

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    settings: 
      output-as: HTML
      expand-shortcuts: false

- # ====== Region: Vista previa de retorno por Inversionista ===
  id: 36943289840691206
  identification: 
    name: Vista previa de retorno por Inversionista
    type: Interactive Report

  source: 
    location: Local Database
    type: SQL Query
    sql-query: |2
          select id_movimiento_financiero
               , id_rol_persona
               , tipo_movimiento
               , signo
               , moneda_rc
               , estado_rc
               , id_cuenta_bancaria
               , monto
               , id_factura
               , id_inversion_factura
               , inversionista
               , numero_cuenta
               , cci
               , id_deposito
               , fecha_movimiento
               , round(monto / :P80_MONTO_PAGO, 4) AS ratio
               , ROUND(bko_operaciones_pkg.calcular_roi(
                          p_tasa_anual      => tasa_interes,
                          p_fecha_pago      => TRUNC(TO_DATE(case 
                                                              when to_date(:P80_FECHA_VENCIMIENTO,'&DATE_FORMAT.') < to_date(:P80_FECHA_PAGO,'&DATE_FORMAT.') then
                                                                  :P80_FECHA_VENCIMIENTO 
                                                              else 
                                                                  :P80_FECHA_PAGO 
                                                              end, '&DATE_FORMAT.')),
                          p_fecha_inversion => TRUNC(TO_DATE(fecha_movimiento, '&DATE_FORMAT.')),
                          p_monto_invertido => monto
                      ), 2) AS interes_ordinario
              --  , ROUND(bko_operaciones_pkg.calcular_roi(
              --             p_tasa_anual      => tasa_interes,
              --             p_fecha_pago      => TRUNC(TO_DATE(:P80_FECHA_PAGO, '&DATE_FORMAT.')),
              --             p_fecha_inversion => TRUNC(TO_DATE(fecha_movimiento, '&DATE_FORMAT.')),
              --             p_monto_invertido => monto
              --         ) * (monto / :P80_MONTO_PAGO), 2) AS interes_ordinario
              --  , CASE 
              --     WHEN :P80_DIAS_ATRASO > 0 
              --     THEN ROUND((:P80_MONTO_PAGO * (tasa_interes / 100) * (:P80_DIAS_ATRASO / 360)) * (monto / :P80_MONTO_PAGO), 2)
              --     ELSE 0
              --    END AS interes_mora
              , CASE 
                  WHEN :P80_DIAS_ATRASO > 0 
                  THEN ROUND(bko_operaciones_pkg.calcular_roi(
                                  p_tasa_anual      => tasa_interes,
                                  p_fecha_pago      => TRUNC(TO_DATE(:P80_FECHA_PAGO,'&DATE_FORMAT.')),
                                  p_fecha_inversion => TRUNC(TO_DATE(:P80_FECHA_VENCIMIENTO, '&DATE_FORMAT.')),
                                  p_monto_invertido => monto
                              ), 2) 
                END AS interes_mora
            from bko_movimiento_financiero_v
           where id_factura         = :P80_ID_FACTURA
             and tipo_movimiento_rc = 'INVERSION'
             and estado_rc          = 'ACTIVO'
    page-items-to-submit: 
    - P80_ID_FACTURA
    - P80_MONTO_PAGO
    - P80_FECHA_PAGO
    - P80_FECHA_VENCIMIENTO

  layout: 
    sequence: 30
    parent-region: No Parent
    slot: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Standard
    template-options: 
    - '#DEFAULT#'
    - t-Region--noPadding
    - t-Region--scrollBody
    - margin-top-sm
    render-components: Above Content

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: false
    exclude-title-from-translation: false

  server-cache: 
    caching: Disabled

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    id: 36943877909691212
    link: 
      link-column: Exclude Link Column

    pagination: 
      type: Row Ranges X to Y
      display-position: Bottom - Right

    performance: 
      lazy-loading: false
      maximum-rows-to-process: 1000000

    search-bar: 
      include-search-bar: true
      search-field: true
      finder-drop-down: true
      reports-select-list: true
      rows-per-page-selector: false

    actions-menu: 
      include-actions-menu: true
      filter: true
      select-columns: true
      rows-per-page: true
      sort: true
      control-break: true
      highlight: true
      compute: true
      aggregate: true
      chart: false
      group-by: true
      pivot: false
      flashback: false
      save-report: true
      save-public-report: false
      reset: true
      help: false
      download: true
      subscription: false

    download: 
      formats: 
      - CSV
      - HTML
      - Excel
      - PDF
      send-as-email: true

    heading: 
      fixed-to: Page

    icon-view: 
      show: false

    detail-view: 
      show: false

    saved-reports: 
    - # ====== Saved Report: Primary Report ========================
      id: 37191254383093851
      identification: 
        name: Primary Report
        alias: 371913

    columns: 
    - # ====== Column: ID_MOVIMIENTO_FINANCIERO ====================
      id: 36943971558691213
      identification: 
        column-name: ID_MOVIMIENTO_FINANCIERO
        type: Hidden

      heading: 
        heading: Id Movimiento Financiero

      layout: 
        sequence: 10

      source: 
        primary-key: false

      security: 
        escape-special-characters: true

    - # ====== Column: ID_ROL_PERSONA ==============================
      id: 36944099360691214
      identification: 
        column-name: ID_ROL_PERSONA
        type: Hidden

      heading: 
        heading: Id Rol Persona

      layout: 
        sequence: 20

      source: 
        primary-key: false

      security: 
        escape-special-characters: true

    - # ====== Column: SIGNO =======================================
      id: 36944201950691216
      identification: 
        column-name: SIGNO
        type: Plain Text

      heading: 
        heading: Signo
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 40
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: MONEDA_RC ===================================
      id: 36944326649691217
      identification: 
        column-name: MONEDA_RC
        type: Plain Text (based on List of Values)

      list-of-values: 
        list-of-values: LOV_MONEDA # 36062349596485909

      heading: 
        heading: Moneda
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 50
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Use Named List of Values to Filter Exact Match

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

    - # ====== Column: ESTADO_RC ===================================
      id: 36944401247691218
      identification: 
        column-name: ESTADO_RC
        type: Plain Text

      heading: 
        heading: Estado Rc
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 60
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: ID_CUENTA_BANCARIA ==========================
      id: 36944504912691219
      identification: 
        column-name: ID_CUENTA_BANCARIA
        type: Hidden

      heading: 
        heading: Id Cuenta Bancaria

      layout: 
        sequence: 70

      source: 
        primary-key: false

      security: 
        escape-special-characters: true

    - # ====== Column: MONTO =======================================
      id: 36944646265691220
      identification: 
        column-name: MONTO
        type: Plain Text

      heading: 
        heading: Monto Capital
        alignment: end

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 80
        column-alignment: end

      accessibility: 
        value-identifies-row: false

      appearance: 
        format-mask: '&NUMBER_FORMAT.'

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: ID_FACTURA ==================================
      id: 36944751702691221
      identification: 
        column-name: ID_FACTURA
        type: Hidden

      heading: 
        heading: Id Factura

      layout: 
        sequence: 90

      source: 
        primary-key: false

      security: 
        escape-special-characters: true

    - # ====== Column: ID_INVERSION_FACTURA ========================
      id: 36944804775691222
      identification: 
        column-name: ID_INVERSION_FACTURA
        type: Hidden

      heading: 
        heading: Id Inversion Factura

      layout: 
        sequence: 100

      source: 
        primary-key: false

      security: 
        escape-special-characters: true

    - # ====== Column: INVERSIONISTA ===============================
      id: 36944978401691223
      identification: 
        column-name: INVERSIONISTA
        type: Plain Text

      heading: 
        heading: Inversionista
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 110
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: NUMERO_CUENTA ===============================
      id: 36945000012691224
      identification: 
        column-name: NUMERO_CUENTA
        type: Plain Text

      heading: 
        heading: Numero Cuenta
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 120
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: CCI =========================================
      id: 36945154057691225
      identification: 
        column-name: CCI
        type: Plain Text

      heading: 
        heading: CCI
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 130
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: ID_DEPOSITO =================================
      id: 36945290527691226
      identification: 
        column-name: ID_DEPOSITO
        type: Plain Text

      heading: 
        heading: Id Deposito
        alignment: end

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 140
        column-alignment: end

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: FECHA_MOVIMIENTO ============================
      id: 36945376795691227
      identification: 
        column-name: FECHA_MOVIMIENTO
        type: Plain Text

      heading: 
        heading: Fecha Movimiento
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 150
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      appearance: 
        format-mask: '&DATE_FORMAT.'

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type
        date-ranges: All

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: TIPO_MOVIMIENTO =============================
      id: 36945410762691228
      identification: 
        column-name: TIPO_MOVIMIENTO
        type: Plain Text

      heading: 
        heading: Tipo Movimiento
        alignment: start

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 160
        column-alignment: start

      accessibility: 
        value-identifies-row: false

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: RATIO =======================================
      id: 36945894634691232
      identification: 
        column-name: RATIO
        type: Plain Text

      heading: 
        heading: Ratio
        alignment: end

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 190
        column-alignment: end

      accessibility: 
        value-identifies-row: false

      appearance: 
        format-mask: '&NUMBER_FORMAT.'

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: INTERES_ORDINARIO ===========================
      id: 36945915883691233
      identification: 
        column-name: INTERES_ORDINARIO
        type: Plain Text

      heading: 
        heading: Interes Ordinario
        alignment: end

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 200
        column-alignment: end

      accessibility: 
        value-identifies-row: false

      appearance: 
        format-mask: '&NUMBER_FORMAT.'

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    - # ====== Column: INTERES_MORA ================================
      id: 36946050982691234
      identification: 
        column-name: INTERES_MORA
        type: Plain Text

      heading: 
        heading: Interes Mora
        alignment: end

      single-row-view: 
        use-column-heading: true

      layout: 
        sequence: 210
        column-alignment: end

      accessibility: 
        value-identifies-row: false

      appearance: 
        format-mask: '&NUMBER_FORMAT.'

      source: 
        primary-key: false

      column-filter: 
        type: Default Based on Column Type

      enable-users-to: 
        hide: true
        sort: true
        filter: true
        highlight: true
        control-break: true
        aggregate: true
        compute: true
        chart: true
        group-by: true
        pivot: true

      security: 
        escape-special-characters: true

    printing: 
      output: 
        layout: Default Report Layout
        view-file-as: Attachment

      page: 
        size: A4
        orientation: Landscape
        units: Millimeters
        width: 297
        height: 210
        border-width: 0.5
        border-color: '#666666'

      page-header: 
        font: Helvetica
        font-weight: Normal
        font-size: 12
        font-color: '#000000'
        alignment: center

      column-headings: 
        font: Helvetica
        font-weight: Bold
        font-size: 10
        font-color: '#000000'
        background-color: '#EEEEEE'

      columns: 
        font: Helvetica
        font-weight: Normal
        font-size: 10
        font-color: '#000000'
        background-color: '#FFFFFF'

      page-footer: 
        font: Helvetica
        font-weight: Normal
        font-size: 12
        font-color: '#000000'
        alignment: center

page-items: 
- # ====== Page Item: P80_ID_FACTURA ===========================
  id: 33140978432256324
  identification: 
    name: P80_ID_FACTURA
    type: Hidden

  settings: 
    value-protected: true

  layout: 
    sequence: 10
    region: No Parent
    slot: BODY

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_FECHA_PAGO ===========================
  id: 33141452916256329
  identification: 
    name: P80_FECHA_PAGO
    type: Date Picker

  label: 
    label: Fecha de Cancelación
    alignment: Left

  settings: 
    show-time: false
    display-as: Popup
    minimum-date: Item
    minimum-item: P80_FECHA_PAGO_MINIMO
    maximum-date: None
    multiple-months: No
    use-defaults: true

  layout: 
    sequence: 70
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: false
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'
    format-mask: '&DATE_FORMAT.'
    width: 30

  validation: 
    value-required: false

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    storage: Per Session (Persistent)

  quick-picks: 
    show-quick-picks: false

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_MONTO_PAGO ===========================
  id: 33141590566256330
  identification: 
    name: P80_MONTO_PAGO
    type: Hidden

  settings: 
    value-protected: true

  layout: 
    sequence: 30
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY

  appearance: 
    format-mask: '&NUMBER_FORMAT.'

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_MONEDA_RC ============================
  id: 33141683704256331
  identification: 
    name: P80_MONEDA_RC
    type: Select List

  label: 
    label: Moneda
    alignment: Left

  settings: 
    page-action-on-selection: None

  multiple-values: 
    type: No

  layout: 
    sequence: 50
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: false
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'
    height: 1

  validation: 
    value-required: false

  list-of-values: 
    type: Shared Component
    list-of-values: LOV_MONEDA # 36062349596485909
    display-extra-values: false
    display-null-value: true

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    storage: Per Session (Persistent)

  quick-picks: 
    show-quick-picks: false

  read-only: 
    type: Always

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_FECHA_VENCIMIENTO ====================
  id: 33141717352256332
  identification: 
    name: P80_FECHA_VENCIMIENTO
    type: Date Picker

  label: 
    label: Fecha de Vencimiento
    alignment: Left

  settings: 
    show-time: false
    display-as: Popup
    minimum-date: None
    maximum-date: None
    multiple-months: No
    use-defaults: true

  layout: 
    sequence: 60
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: false
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'
    format-mask: '&DATE_FORMAT.'
    width: 30

  validation: 
    value-required: false

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    storage: Per Session (Persistent)

  quick-picks: 
    show-quick-picks: false

  read-only: 
    type: Always

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_DIAS_ATRASO ==========================
  id: 33141838377256333
  identification: 
    name: P80_DIAS_ATRASO
    type: Display Only

  label: 
    label: Dias de Atraso
    alignment: Left

  settings: 
    format: Plain Text
    based-on: Item Value
    show-line-breaks: true
    send-on-page-submit: false

  layout: 
    sequence: 80
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: 3
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'

  advanced: 
    css-classes: 
    - u-textEnd
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_INTERES_MORA =========================
  id: 33141929189256334
  identification: 
    name: P80_INTERES_MORA
    type: Display Only

  label: 
    label: Interes Moratorio
    alignment: Left

  settings: 
    format: Plain Text
    based-on: Item Value
    show-line-breaks: true
    send-on-page-submit: false

  layout: 
    sequence: 110
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: false
    column: Automatic
    new-column: true
    column-span: 3
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'

  advanced: 
    css-classes: 
    - u-textEnd
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_FECHA_PAGO_MINIMO ====================
  id: 33142041854256335
  identification: 
    name: P80_FECHA_PAGO_MINIMO
    type: Hidden

  settings: 
    value-protected: true

  layout: 
    sequence: 10
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_INTERES_ORDINARIO ====================
  id: 36943126065691205
  identification: 
    name: P80_INTERES_ORDINARIO
    type: Display Only

  label: 
    label: Interes Ordinario
    alignment: Left

  settings: 
    format: Plain Text
    based-on: Item Value
    show-line-breaks: true
    send-on-page-submit: false

  layout: 
    sequence: 100
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: false
    column: Automatic
    new-column: true
    column-span: 3
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'

  advanced: 
    css-classes: 
    - u-textEnd
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_TEA ==================================
  id: 36946193087691235
  identification: 
    name: P80_TEA
    type: Display Only

  label: 
    label: TEA %
    alignment: Left

  settings: 
    format: Plain Text
    based-on: Item Value
    show-line-breaks: true
    send-on-page-submit: false

  layout: 
    sequence: 90
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: false
    column: Automatic
    new-column: true
    column-span: 3
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'

  advanced: 
    css-classes: 
    - u-textEnd
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P80_MONTO_PAGO_DISP ======================
  id: 42065054173500305
  identification: 
    name: P80_MONTO_PAGO_DISP
    type: Display Only

  label: 
    label: Monto de Cancelación
    alignment: Left

  settings: 
    format: Plain Text
    based-on: Item Value
    show-line-breaks: true
    send-on-page-submit: true

  layout: 
    sequence: 20
    region: Registro de Cancelacion # 33141055977256325
    slot: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating
    template-options: 
    - '#DEFAULT#'
    format-mask: '&NUMBER_FORMAT.'

  advanced: 
    css-classes: 
    - u-textEnd
    warn-on-unsaved-changes: Page Default

  source: 
    type: Expression
    language: PL/SQL
    pl/sql-expression: "to_char(:P80_MONTO_PAGO,'&NUMBER_FORMAT.')"
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

buttons: 
- # ====== Button: CONFIRMAR_CANCELACION =======================
  id: 33141266359256327
  identification: 
    button-name: CONFIRMAR_CANCELACION
    label: Confirmar

  layout: 
    sequence: 20
    region: Botonera # 33141102698256326
    slot: CREATE
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    button-template: Text
    hot: true
    template-options: 
    - '#DEFAULT#'

  behavior: 
    action: Submit Page
    execute-validations: true
    show-processing: false
    warn-on-unsaved-changes: Do Not Check

  confirmation: 
    message: |
      <b>¿Confirmar la Cancelación de la Factura?</b>
      <p>Se distribuirá el retorno de la Inversión a los Inversionistas. <b>Esta acción no se puede deshacer.</b></p>
    style: Default

- # ====== Button: CANCELAR ====================================
  id: 33141352017256328
  identification: 
    button-name: CANCELAR
    label: Cancelar

  layout: 
    sequence: 10
    region: Botonera # 33141102698256326
    slot: CLOSE
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    button-template: Text
    hot: false
    template-options: 
    - '#DEFAULT#'

  behavior: 
    action: Defined by Dynamic Action
    execute-validations: true

- # ====== Button: PREVISUALIZAR ===============================
  id: 36943523657691209
  identification: 
    button-name: PREVISUALIZAR
    label: Vista Previa

  layout: 
    sequence: 10
    region: Botonera # 33141102698256326
    slot: CREATE
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    button-template: Text with Icon
    hot: false
    template-options: 
    - '#DEFAULT#'
    - t-Button--iconLeft
    icon: fa-ai-sparkle-zoom-in

  behavior: 
    action: Defined by Dynamic Action
    execute-validations: true

- # ====== Button: RECALCULAR ==================================
  id: 36945782599691231
  identification: 
    button-name: RECALCULAR
    label: Recalcular

  layout: 
    sequence: 10
    region: Vista previa de retorno por Inversionista # 36943289840691206
    slot: RIGHT_OF_IR_SEARCH_BAR
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    button-template: Text with Icon
    hot: false
    template-options: 
    - '#DEFAULT#'
    - t-Button--iconLeft
    icon: fa-gears

  behavior: 
    action: Defined by Dynamic Action
    execute-validations: true

dynamic-actions: 
- # ====== Dynamic Action: onClick - Cancelar ==================
  id: 35245202451920723
  identification: 
    name: onClick - Cancelar

  execution: 
    sequence: 10
    event-scope: Static
    type: Immediate

  when: 
    event: Click
    selection-type: Button
    button: CANCELAR # 33141352017256328

  actions: 
  - # ====== Action: Cancel Dialog ===============================
    id: 35245302930920724
    identification: 
      action: Cancel Dialog

    execution: 
      sequence: 10
      event: onClick - Cancelar # 35245202451920723
      fire-when-event-result-is: True
      fire-on-initialization: false

- # ====== Dynamic Action: onChange - Fecha Pago ===============
  id: 35245562942920726
  identification: 
    name: onChange - Fecha Pago

  execution: 
    sequence: 20
    event-scope: Static
    type: Immediate

  when: 
    event: Change
    selection-type: Item(s)
    item(s): 
    - P80_FECHA_PAGO

  client-side-condition: 
    type: Item is not null
    item: P80_FECHA_PAGO

  actions: 
  - # ====== Action: Execute Server-side Code ====================
    id: 35245664720920727
    identification: 
      action: Execute Server-side Code

    settings: 
      language: PE.PROPERTY.SOURCE_SNIPPET_LANG.LOV.PLSQL.D
      pl/sql-code: |
        DECLARE
            l_roi NUMBER;
            l_interes_mora NUMBER;
        BEGIN
            :P80_DIAS_ATRASO := GREATEST(0, trunc(to_date(:P80_FECHA_PAGO,'&DATE_FORMAT.'))-trunc(to_date(:P80_FECHA_VENCIMIENTO,'&DATE_FORMAT.')));
        
            select bko_operaciones_pkg.calcular_roi(
                        p_tasa_anual      => tasa_interes
                      , p_fecha_pago      => TRUNC(TO_DATE(:P80_FECHA_PAGO,'&DATE_FORMAT.'))
                      , p_fecha_inversion => TRUNC(TO_DATE(fecha_ingreso,'&DATE_FORMAT.'))
                      , p_monto_invertido => saldo_a_pago
                      ) as roi
                --  , saldo_a_pago * (tasa_interes / 100) * (to_number(:P80_DIAS_ATRASO) / 360)
                 , ROUND(bko_operaciones_pkg.calcular_roi(
                        p_tasa_anual      => tasa_interes,
                        p_fecha_pago      => TRUNC(TO_DATE(:P80_FECHA_PAGO,'&DATE_FORMAT.')),
                        p_fecha_inversion => TRUNC(TO_DATE(:P80_FECHA_VENCIMIENTO, '&DATE_FORMAT.')),
                        p_monto_invertido => saldo_a_pago
                    ), 2) 
                  AS interes_moratorio
              into l_roi
                 , l_interes_mora
              from factura_v
             where id_factura = :P80_ID_FACTURA;
        
            :P80_INTERES_ORDINARIO := to_char(round(l_roi,2),'&NUMBER_FORMAT.');
            :P80_INTERES_MORA := to_char(round(l_interes_mora,2),'&NUMBER_FORMAT.');
        END;
      items-to-submit: 
      - P80_FECHA_VENCIMIENTO
      - P80_FECHA_PAGO
      items-to-return: 
      - P80_DIAS_ATRASO
      - P80_INTERES_ORDINARIO
      - P80_INTERES_MORA
      suppress-change-event: false

    execution: 
      sequence: 20
      event: onChange - Fecha Pago # 35245562942920726
      fire-when-event-result-is: True
      fire-on-initialization: false
      stop-execution-on-error: true
      wait-for-result: true

  - # ====== Action: Refresh =====================================
    id: 36946272379691236
    identification: 
      action: Refresh

    settings: 
      maintain-pagination: false

    affected-elements: 
      selection-type: Region
      region: Vista previa de retorno por Inversionista # 36943289840691206

    execution: 
      sequence: 30
      event: onChange - Fecha Pago # 35245562942920726
      fire-when-event-result-is: True
      fire-on-initialization: false

  - # ====== Action: Disable =====================================
    id: 36946681899691240
    identification: 
      action: Disable

    affected-elements: 
      selection-type: Button
      button: PREVISUALIZAR # 36943523657691209

    execution: 
      sequence: 10
      event: onChange - Fecha Pago # 35245562942920726
      fire-when-event-result-is: True
      fire-on-initialization: false

- # ====== Dynamic Action: onPageLoad ==========================
  id: 36943390116691207
  identification: 
    name: onPageLoad

  execution: 
    sequence: 30
    event-scope: Static

  when: 
    event: Page Load

  actions: 
  - # ====== Action: Hide ========================================
    id: 36943409272691208
    identification: 
      action: Hide

    affected-elements: 
      selection-type: Region
      region: Vista previa de retorno por Inversionista # 36943289840691206

    execution: 
      sequence: 10
      event: onPageLoad # 36943390116691207
      fire-when-event-result-is: True
      fire-on-initialization: true

  - # ====== Action: Disable =====================================
    id: 36946344784691237
    identification: 
      action: Disable

    affected-elements: 
      selection-type: Button
      button: PREVISUALIZAR # 36943523657691209

    execution: 
      sequence: 20
      event: onPageLoad # 36943390116691207
      fire-when-event-result-is: True
      fire-on-initialization: true

- # ====== Dynamic Action: onClick - Previsualizar =============
  id: 36943633092691210
  identification: 
    name: onClick - Previsualizar

  execution: 
    sequence: 40
    event-scope: Static
    type: Immediate

  when: 
    event: Click
    selection-type: Button
    button: PREVISUALIZAR # 36943523657691209

  actions: 
  - # ====== Action: Show ========================================
    id: 36943762622691211
    identification: 
      action: Show

    affected-elements: 
      selection-type: Region
      region: Vista previa de retorno por Inversionista # 36943289840691206

    execution: 
      sequence: 10
      event: onClick - Previsualizar # 36943633092691210
      fire-when-event-result-is: True
      fire-on-initialization: false

- # ====== Dynamic Action: afterRefresh - Retorno Por Inversioni
  id: 36946474607691238
  identification: 
    name: afterRefresh - Retorno Por Inversionista

  execution: 
    sequence: 50
    event-scope: Static
    type: Immediate

  when: 
    event: After Refresh
    selection-type: Region
    region: Vista previa de retorno por Inversionista # 36943289840691206

  actions: 
  - # ====== Action: Enable ======================================
    id: 36946559825691239
    identification: 
      action: Enable

    affected-elements: 
      selection-type: Button
      button: PREVISUALIZAR # 36943523657691209

    execution: 
      sequence: 10
      event: afterRefresh - Retorno Por Inversionista # 36946474607691238
      fire-when-event-result-is: True
      fire-on-initialization: false

- # ====== Dynamic Action: onClick - Recalcular ================
  id: 37227691987164425
  identification: 
    name: onClick - Recalcular

  execution: 
    sequence: 60
    event-scope: Static
    type: Immediate

  when: 
    event: Click
    selection-type: Button
    button: RECALCULAR # 36945782599691231

  actions: 
  - # ====== Action: Refresh =====================================
    id: 37227783952164426
    identification: 
      action: Refresh

    settings: 
      maintain-pagination: false

    affected-elements: 
      selection-type: Region
      region: Vista previa de retorno por Inversionista # 36943289840691206

    execution: 
      sequence: 10
      event: onClick - Recalcular # 37227691987164425
      fire-when-event-result-is: True
      fire-on-initialization: false

processes: 
- # ====== Process: Initialize =================================
  id: 33142126251256336
  identification: 
    name: Initialize
    type: Execute Code
    execution-chain: None

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |2
          select to_char(fecha_emision,'&DATE_FORMAT.')
               , to_char(fecha_vencimiento,'&DATE_FORMAT.')
               , moneda_rc
               , saldo_a_pago
               , to_char(tasa_interes,'&NUMBER_FORMAT.')
            into :P80_FECHA_PAGO_MINIMO
               , :P80_FECHA_VENCIMIENTO
               , :P80_MONEDA_RC
               , :P80_MONTO_PAGO
               , :P80_TEA
            from bko_factura
           where id_factura = :P80_ID_FACTURA;

  execution: 
    sequence: 10
    point: Before Header
    run-process: Once Per Page Visit (default)

- # ====== Process: Process Cancelacion ========================
  id: 35245412068920725
  identification: 
    name: Process Cancelacion
    type: Execute Code
    execution-chain: None

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      /* ============================================================================
         Liquidación de factura: devolución de capital + intereses (ordinario y mora)
         Ajustes aplicados:
         1.  Cálculos de interés.
         2.  Proporción de cada inversión = inv.monto / l_saldo_a_pago (variable v_ratio).
         3.  Verificación de l_saldo_a_pago = 0 para evitar división por cero.
         4.  Cursor filtrado SOLO por movimientos de tipo INVERSION y estado ACTIVO.
         5.  Redondeo únicamente al final (dos decimales) para minimizar diferencias.
         6.  Interés de mora incluido en el mismo bloque, solo si l_interes_mora > 0.
         7.  Hora real preservada con SYSDATE; trunca la fecha solo si así lo exige
             la lógica contable.
         =========================================================================== */
      DECLARE
         l_saldo_a_pago      NUMBER;          -- Saldo total a pagar de la factura
         l_interes_ordinario NUMBER;          -- Interés ordinario total de la factura
         l_interes_mora      NUMBER;          -- Interés de mora total de la factura
         l_plazo_en_dias     NUMBER;
         l_tasa_interes      NUMBER;
         l_id_movimiento_financiero bko_movimiento_financiero.id_movimiento_financiero%TYPE;
      BEGIN
         /* Obtener valores globales de la factura -------------------------------- */
          --Obtener el Interes Total a Devolver de la Factura
          select saldo_a_pago
              --  , bko_operaciones_pkg.calcular_roi(
              --         p_tasa_anual      => tasa_interes
              --       , p_fecha_pago      => TRUNC(TO_DATE(:P80_FECHA_PAGO,'&DATE_FORMAT.')) --Fecha de Cancelacion
              --       , p_fecha_inversion => TRUNC(TO_DATE(fecha_ingreso,'&DATE_FORMAT.'))   --Fecha de Ingreso de Factura
              --       , p_monto_invertido => saldo_a_pago
              --       ) as interes_ordinario
              --  , (((saldo_a_pago * tasa_interes)/100)/30)*dias_atraso
      
              --  , saldo_a_pago * (tasa_interes / 100) * (to_number(:P80_DIAS_ATRASO) / 360) as interes_moratorio
               , ROUND(bko_operaciones_pkg.calcular_roi(
                                  p_tasa_anual      => tasa_interes,
                                  p_fecha_pago      => TRUNC(TO_DATE(:P80_FECHA_PAGO,'&DATE_FORMAT.')),
                                  p_fecha_inversion => TRUNC(TO_DATE(:P80_FECHA_VENCIMIENTO, '&DATE_FORMAT.')),
                                  p_monto_invertido => saldo_a_pago
                              ), 2) 
                AS interes_moratorio
               , tasa_interes
            into l_saldo_a_pago
              --  , l_interes_ordinario
               , l_interes_mora
               , l_tasa_interes
            from factura_v
           where id_factura = :P80_ID_FACTURA;
      
          /* Si no hay saldo a pagar (ya se liquidó) salimos sin hacer nada --------- */
          IF l_saldo_a_pago = 0 THEN
              RETURN;
          END IF;
         
          /* Procesar cada inversión activa en la factura -------------------------- */
          FOR inv IN ( SELECT id_rol_persona
                            , id_factura
                            , id_inversion_factura
                            , monto  --Monto Capital
                            , moneda_rc
                            , id_cuenta_bancaria
                            , fecha_movimiento
                         FROM bko_movimiento_financiero_v 
                        WHERE id_factura          = :P80_ID_FACTURA
                          AND tipo_movimiento_rc  = 'INVERSION'
                          AND estado_rc           = 'ACTIVO'
          )LOOP
          /* Proporción de esta inversión respecto al saldo total de la factura */
              DECLARE
                  v_ratio             NUMBER := inv.monto / l_saldo_a_pago;
                  v_interes_ordinario NUMBER;
              BEGIN
                  /* ---------- DEVOLUCIÓN DE CAPITAL -------------------------------- */
                  l_id_movimiento_financiero := null;
                  bko_transacciones_pkg.registrar_movimiento_financiero(
                      p_id_movimiento_financiero => l_id_movimiento_financiero,
                      p_id_rol_persona           => inv.id_rol_persona,
                      p_id_factura               => inv.id_factura,
                      p_id_inversion_factura     => inv.id_inversion_factura,
                      p_tipo_movimiento_rc       => 'DEVOLUCION_CAPITAL',
                      p_monto                    => inv.monto,
                      p_moneda_rc                => inv.moneda_rc,
                      p_estado_rc                => 'ACTIVO',
                      p_referencia_externa       => NULL,
                      p_fecha_movimiento         => TRUNC(CURRENT_TIMESTAMP),
                      p_observaciones            => 'Cancelacion de factura',
                      p_id_cuenta_bancaria       => inv.id_cuenta_bancaria
                   );
      
                  /* ---------- PAGO DE INTERÉS ORDINARIO ---------------------------- */
                  -- Calcular interés individual por inversión
                  v_interes_ordinario := bko_operaciones_pkg.calcular_roi(
                      p_tasa_anual      => l_tasa_interes,  -- Debería venir de inv.tasa_interes si varía
                      p_fecha_pago      => TRUNC(TO_DATE(case 
                                                          when to_date(:P80_FECHA_VENCIMIENTO,'&DATE_FORMAT.')<to_date(:P80_FECHA_PAGO,'&DATE_FORMAT.') 
                                                          then :P80_FECHA_VENCIMIENTO 
                                                          else :P80_FECHA_PAGO 
                                                         end, '&DATE_FORMAT.')),
                      p_fecha_inversion => TRUNC(TO_DATE(inv.fecha_movimiento, '&DATE_FORMAT.')),
                      p_monto_invertido => inv.monto
                  );
      
                  l_id_movimiento_financiero := null;
                  bko_transacciones_pkg.registrar_movimiento_financiero(
                      p_id_movimiento_financiero => l_id_movimiento_financiero,
                      p_id_rol_persona           => inv.id_rol_persona,
                      p_id_factura               => inv.id_factura,
                      p_id_inversion_factura     => inv.id_inversion_factura,
                      p_tipo_movimiento_rc       => 'PAGO_INTERES',
                      p_monto                    => ROUND(v_interes_ordinario, 2),
                      p_moneda_rc                => inv.moneda_rc,
                      p_estado_rc                => 'ACTIVO',
                      p_referencia_externa       => NULL,
                      p_fecha_movimiento         => TRUNC(CURRENT_TIMESTAMP),
                      p_observaciones            => 'Cancelacion de factura',
                      p_id_cuenta_bancaria       => inv.id_cuenta_bancaria
                   );
      
               /* ---------- PAGO DE INTERÉS DE MORA (si aplica) ------------------- */
               IF l_interes_mora > 0 THEN
                  l_id_movimiento_financiero := null;
                  bko_transacciones_pkg.registrar_movimiento_financiero(
                       p_id_movimiento_financiero => l_id_movimiento_financiero,
                       p_id_rol_persona           => inv.id_rol_persona,
                       p_id_factura               => inv.id_factura,
                       p_id_inversion_factura     => inv.id_inversion_factura,
                       p_tipo_movimiento_rc       => 'PAGO_INTERES_MORA',
                       p_monto                    => ROUND(l_interes_mora * v_ratio, 2),
                       p_moneda_rc                => inv.moneda_rc,
                       p_estado_rc                => 'ACTIVO',
                       p_referencia_externa       => NULL,
                       p_fecha_movimiento         => TRUNC(CURRENT_TIMESTAMP),
                       p_observaciones            => 'Cancelacion de factura',
                       p_id_cuenta_bancaria       => inv.id_cuenta_bancaria
                  );
               END IF;
               
              END;
          END LOOP;
          
          update bko_factura 
             set fecha_pago = trunc(to_date(:P80_FECHA_PAGO,'&DATE_FORMAT.'))
               , estado_factura_rc = 'FACT_CANCELADA' 
           where id_factura = :P80_ID_FACTURA; 
      
      END;

  execution: 
    sequence: 10
    point: Processing
    run-process: Once Per Page Visit (default)

  error: 
    display-location: Inline in Notification

- # ====== Process: Close Dialog ===============================
  id: 35245789585920728
  identification: 
    name: Close Dialog
    type: Close Dialog
    execution-chain: None

  settings: 
    show-success-messages: true

  execution: 
    sequence: 20
    point: Processing
    run-process: Once Per Page Visit (default)

  error: 
    display-location: Inline in Notification

